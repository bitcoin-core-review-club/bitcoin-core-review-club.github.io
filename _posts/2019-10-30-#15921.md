---
layout: pr
date: 2019-10-30
title: "#15921 validation: Tidy up ValidationState interface"
pr: 15921
authors: [jnewbery]
components: ["validation"]
host: jnewbery
---

**Happy half-anniversary to PR review club ðŸŽ‰**

## Notes

- This is a follow-up to [PR
  15141](https://github.com/bitcoin/bitcoin/pull/15141), which rewrote how DoS
  protection was handled. Previously, validation would assign DoS scores if a
  transaction or block was rejected, and pass the score back to net processing
  inside a `CValidationState` object. Net processing could then disconnect or
  ban the peer that provided the transaction or block. PR 15141 moved DoS
  handling responsibility to net processing.
- Net processing (and other components like the wallet/RPC) pass new inventory
  (transactions, blocks and headers) to validation through different function
  calls, such as:
  - [AcceptToMemoryPool()](https://github.com/bitcoin/bitcoin/blob/4af04471695297e59fb0c855ab8fe6f6c618f8f2/src/validation.cpp#L1071)
    (_ATMP_) processes a transaction for acceptance to the memory pool.
  - [ProcessNewBlock()](https://github.com/bitcoin/bitcoin/blob/4af04471695297e59fb0c855ab8fe6f6c618f8f2/src/validation.cpp#L3746)
    (_PNB_) processes a new block (and if it's valid, adds it to our mapBlockIndex and
    potentially adds it to the block chain).
  - [ProcessNewBlockHeaders()](https://github.com/bitcoin/bitcoin/blob/4af04471695297e59fb0c855ab8fe6f6c618f8f2/src/validation.cpp#L3616)
    (_PNBH_) processes a vector of block headers.
- Both ATMP and PNBH have a `CValidationState&` argument. The function returns
  details about the validation of the transaction or headers in that state
  object. PNB doesn't currently take a state argument, but instead receives
  state back from PNB through the `CValidationInterface::BlockChecked()`
  callback. [PR 16279](https://github.com/bitcoin/bitcoin/pull/16279) (covered
  in [a previous PR review club](https://bitcoincore.reviews/16279.html)) would
  add that state argument to PNB.
- The `CValidationState` object was introduced in [PR
  2224](https://github.com/bitcoin/bitcoin/pull/2224), including [DoS score
  tracking](https://github.com/bitcoin/bitcoin/pull/2224/files#diff-e8db9b851adc2422aadfffca88f14c91R1881).
- This PR tidies up some loose ends left by PR 15141. Most notably it adds
  `BlockValidationState` and `TxValidationState` as derived classes of
  `ValidationState`, since the reasons that a block and transaction can be
  rejected are different.
- The important changes in this PR are in `src/consensus/validation.h`. Most of
  the other changes are updating the call sites to use the changed objects.
- This PR is much easier to review if you look at the commits individually,
  especially if you use ryanofsky's review tip in the [PR
  description](https://github.com/bitcoin/bitcoin/pull/15921#issue-274447642).

## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or
  NACK?](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)
  (Don't forget to put your PR review on GitHub.)

2. What steps did you take, beyond reading the code?

3. Does this PR change any behaviour, or is it a pure refactor?

4. Why do you think we have different validation results for
   `RECENT_CONSENSUS_CHANGE` and `CONSENSUS`?

5. Prepare one of the following for the review club:
  - a question of your own about the PR or code;
  - an observation you made from reviewing the PR.
